<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ csrf_token() }}">
    <title>Images - Chrontainer</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect fill='%232c3e50' width='100' height='100' rx='20'/%3E%3Ctext x='50' y='70' font-size='70' text-anchor='middle' fill='%233498db'%3Eüê≥%3C/text%3E%3C/svg%3E">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }

        body.dark-mode {
            background: #1a1a1a;
            color: #ecf0f1;
        }

        .container {
            max-width: 90%;
            width: 90%;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: #2c3e50;
            color: white;
            padding: 20px 0;
            margin-bottom: 30px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        header h1 {
            font-size: 28px;
            font-weight: 600;
        }

        .nav-links {
            margin-top: 10px;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 6px;
        }

        .nav-links a {
            color: #3498db;
            text-decoration: none;
            margin-right: 14px;
            font-size: 14px;
        }

        .nav-links a:hover {
            text-decoration: underline;
        }

        .section {
            background: white;
            border-radius: 8px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        body.dark-mode header {
            background: #1f2d3a;
        }

        body.dark-mode .section {
            background: #2c3e50;
        }

        .section h2 {
            font-size: 22px;
            margin-bottom: 20px;
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }

        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
            margin-bottom: 16px;
        }

        .unused-filter {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 13px;
        }

        .unused-filter input {
            margin: 0;
            width: auto;
            min-width: 0;
        }

        .controls input[type="text"],
        .controls select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .controls input[type="text"] {
            flex: 1;
            min-width: 220px;
        }

        .btn {
            border: none;
            border-radius: 4px;
            padding: 8px 14px;
            font-size: 13px;
            cursor: pointer;
        }

        .btn-primary {
            background: #3498db;
            color: white;
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-secondary {
            background: #95a5a6;
            color: white;
        }

        .btn-small {
            padding: 6px 10px;
            font-size: 12px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: #34495e;
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            font-size: 14px;
        }

        td {
            padding: 12px;
            border-bottom: 1px solid #ecf0f1;
            font-size: 14px;
        }

        body.dark-mode td {
            border-bottom: 1px solid #3d566e;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .host-pill {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 999px;
            font-size: 12px;
            font-weight: 600;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
        }

        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 2000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .toast {
            background: #2c3e50;
            color: white;
            padding: 10px 14px;
            border-radius: 6px;
            font-size: 13px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            min-width: 200px;
        }

        .toast.success {
            background: #2ecc71;
        }

        .toast.error {
            background: #e74c3c;
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <h1>üê≥ Chrontainer <span style="font-size: 14px; color: #3498db; font-weight: normal;">v{{ version }}</span></h1>
            <div class="nav-links">
                <a href="/">Dashboard</a>
                <a href="/images">Images</a>
                <a href="/logs">Logs</a>
                <a href="/metrics">Host Metrics</a>
                <a href="/settings">Settings</a>
            </div>
        </div>
    </header>

    <div class="toast-container" id="alertContainer"></div>

    <div class="container">
        <div class="section">
            <h2>Images</h2>
            <div class="controls">
                <input type="text" id="filterQuery" placeholder="Filter by repository or tag..." onkeyup="filterImages()">
                <select id="filterHost" onchange="filterImages()">
                    <option value="">All Hosts</option>
                </select>
                <label class="unused-filter">
                    <input type="checkbox" id="filterUnused" onchange="filterImages()">
                    Unused only
                </label>
                <button class="btn btn-secondary" onclick="loadImages(true)">Refresh</button>
            </div>
            <div class="controls">
                <input type="text" id="pullImageInput" placeholder="Pull image (e.g. ghcr.io/org/app:latest)">
                <select id="pullHostSelect"></select>
                <button class="btn btn-primary host-action-btn" onclick="pullImage()">Pull</button>
                <button class="btn btn-danger host-action-btn" id="pruneBtn" onclick="pruneImages()">Prune Unused</button>
            </div>

            <div class="controls" style="margin-bottom: 10px;">
                <label style="display: inline-flex; align-items: center; gap: 6px; font-size: 13px;">
                    <input type="checkbox" id="selectAllImages" onchange="toggleSelectAllImages(this)">
                    Select all
                </label>
                <span id="selectedCount" style="font-size: 13px; color: #666;">0 selected</span>
                <button class="btn btn-danger btn-small" onclick="deleteSelectedImages()">Delete Selected</button>
            </div>

            <div id="imagesTableWrapper">
                <table>
                    <thead>
                        <tr>
                            <th style="width: 36px;"></th>
                            <th>Host</th>
                            <th>Repository</th>
                            <th>Tag</th>
                            <th>Image ID</th>
                            <th>Size</th>
                            <th>Created</th>
                            <th>Containers</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="imagesBody">
                        <tr>
                            <td colspan="9" class="empty-state">Loading images...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        let allImages = [];
        let hostMap = {};
        let hostActionsBlocked = false;

        function getCsrfToken() {
            return document.querySelector('meta[name="csrf-token"]').getAttribute('content');
        }

        function showToast(message, type = 'info') {
            const container = document.getElementById('alertContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 4000);
        }

        function formatBytes(bytes) {
            if (bytes === null || bytes === undefined) return '--';
            if (!bytes) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function formatDate(value) {
            if (!value) return '--';
            const date = new Date(value);
            if (Number.isNaN(date.getTime())) {
                return value;
            }
            return date.toLocaleString();
        }

        async function loadHosts() {
            const response = await fetch('/api/hosts');
            const data = await response.json();
            const hostSelects = [document.getElementById('filterHost'), document.getElementById('pullHostSelect')];

            hostSelects.forEach(select => {
                select.innerHTML = '';
            });

            const filterOption = document.createElement('option');
            filterOption.value = '';
            filterOption.textContent = 'All Hosts';
            hostSelects[0].appendChild(filterOption);

            const enabledHosts = data.filter(host => host.enabled);
            hostActionsBlocked = false;
            document.querySelectorAll('.host-action-btn').forEach(button => {
                button.disabled = false;
            });
            if (!enabledHosts.length) {
                const pullOption = document.createElement('option');
                pullOption.value = '';
                pullOption.textContent = 'No enabled hosts';
                hostSelects[1].appendChild(pullOption);
                hostActionsBlocked = true;
                document.querySelectorAll('.host-action-btn').forEach(button => {
                    button.disabled = true;
                });
                return;
            }

            enabledHosts.forEach(host => {
                hostMap[host.id] = host;
                const option = document.createElement('option');
                option.value = host.id;
                option.textContent = host.name;
                hostSelects[0].appendChild(option);

                const pullOption = document.createElement('option');
                pullOption.value = host.id;
                pullOption.textContent = host.name;
                hostSelects[1].appendChild(pullOption);
            });
        }

        async function loadImages(forceRefresh = false) {
            try {
                const url = forceRefresh ? '/api/images?refresh=1' : '/api/images';
                if (forceRefresh) {
                    pendingAttempts = 0;
                }
                const response = await fetch(url);
                const data = await response.json();
                if (response.ok) {
                    allImages = data;
                    clearSelections();
                    filterImages();
                    scheduleRefreshIfPending(data);
                    updatePruneState();
                } else {
                    showToast(data.error || 'Failed to load images', 'error');
                }
            } catch (error) {
                showToast('Failed to load images', 'error');
            }
        }

        let pendingRefreshTimer = null;
        let pendingAttempts = 0;
        function scheduleRefreshIfPending(images) {
            const needsRefresh = images.some(image =>
                image.containers === null ||
                image.containers === undefined ||
                image.size_bytes === null ||
                image.size_bytes === undefined
            );
            if (!needsRefresh) {
                pendingAttempts = 0;
                updatePruneState();
                return;
            }
            if (pendingRefreshTimer || pendingAttempts >= 10) {
                return;
            }
            pendingRefreshTimer = setTimeout(() => {
                pendingRefreshTimer = null;
                pendingAttempts += 1;
                loadImages();
            }, 10000);
        }

        function filterImages() {
            const query = document.getElementById('filterQuery').value.toLowerCase();
            const hostFilter = document.getElementById('filterHost').value;
            const unusedOnly = document.getElementById('filterUnused').checked;

            const filtered = allImages.filter(image => {
                const matchesQuery = !query ||
                    (image.repository || '').toLowerCase().includes(query) ||
                    (image.tag || '').toLowerCase().includes(query);
                const matchesHost = !hostFilter || String(image.host_id) === hostFilter;
                const matchesUnused = !unusedOnly || image.containers === 0;
                return matchesQuery && matchesHost && matchesUnused;
            });

            renderImages(filtered);
        }

        function updatePruneState() {
            const pruneBtn = document.getElementById('pruneBtn');
            if (!pruneBtn) return;
            if (hostActionsBlocked) {
                pruneBtn.disabled = true;
                pruneBtn.title = 'No enabled hosts available';
                return;
            }
            const hasPending = allImages.some(image =>
                image.containers === null ||
                image.containers === undefined ||
                image.size_bytes === null ||
                image.size_bytes === undefined
            );
            pruneBtn.disabled = hasPending;
            pruneBtn.title = hasPending ? 'Wait for image data to finish loading' : '';
        }

        function renderImages(images) {
            const tbody = document.getElementById('imagesBody');
            if (!images.length) {
                tbody.innerHTML = '<tr><td colspan="9" class="empty-state">No images found</td></tr>';
                return;
            }

            tbody.innerHTML = images.map(image => `
                <tr>
                    <td>
                        <input
                            type="checkbox"
                            class="image-select"
                            data-image-id="${image.id}"
                            data-host-id="${image.host_id}"
                        >
                    </td>
                    <td>
                        <span class="host-pill" style="background: ${image.host_color || '#e8f4f8'}; color: ${image.host_text_color || '#2c3e50'};">
                            ${image.host_name}
                        </span>
                    </td>
                    <td>${image.repository}</td>
                    <td>${image.tag}</td>
                    <td title="${image.image_id}">${image.short_id}</td>
                    <td>${formatBytes(image.size_bytes)}</td>
                    <td>${formatDate(image.created)}</td>
                    <td>${image.containers === null || image.containers === undefined ? '--' : image.containers}</td>
                    <td>
                        <button
                            class="btn btn-danger btn-small delete-image-btn"
                            data-image-id="${image.id}"
                            data-host-id="${image.host_id}"
                            data-image-name="${image.full_name}"
                        >
                            Delete
                        </button>
                    </td>
                </tr>
            `).join('');

            document.querySelectorAll('.delete-image-btn').forEach(button => {
                button.addEventListener('click', () => {
                    deleteImage(button.dataset.imageId, button.dataset.hostId, button.dataset.imageName);
                });
            });

            document.querySelectorAll('.image-select').forEach(checkbox => {
                checkbox.addEventListener('change', updateSelectedCount);
            });
            updateSelectedCount();
        }

        async function pullImage() {
            const imageRef = document.getElementById('pullImageInput').value.trim();
            const hostId = document.getElementById('pullHostSelect').value;

            if (!imageRef) {
                showToast('Enter an image reference', 'error');
                return;
            }

            try {
                const response = await fetch('/api/images/pull', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCsrfToken()
                    },
                    body: JSON.stringify({ image: imageRef, host_id: parseInt(hostId, 10) })
                });
                const data = await response.json();
                if (response.ok) {
                    showToast(data.message || 'Image pulled', 'success');
                    document.getElementById('pullImageInput').value = '';
                    loadImages();
                } else {
                    showToast(data.error || 'Failed to pull image', 'error');
                }
            } catch (error) {
                showToast('Failed to pull image', 'error');
            }
        }

        async function pruneImages() {
            const hostId = document.getElementById('pullHostSelect').value;
            if (!confirm('Prune unused images on this host?')) {
                return;
            }

            try {
                const response = await fetch('/api/images/prune', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCsrfToken()
                    },
                    body: JSON.stringify({ host_id: parseInt(hostId, 10), dangling_only: false })
                });
                const data = await response.json();
                if (response.ok) {
                    const reclaimed = formatBytes(data.reclaimed || 0);
                    showToast(`Pruned images (${reclaimed} reclaimed)`, 'success');
                    loadImages();
                } else {
                    showToast(data.error || 'Failed to prune images', 'error');
                }
            } catch (error) {
                showToast('Failed to prune images', 'error');
            }
        }

        async function deleteImage(imageId, hostId, imageName) {
            if (!confirm(`Delete ${imageName}?`)) {
                return;
            }

            const success = await deleteImageRequest(imageId, hostId);
            if (success) {
                loadImages();
            }
        }

        async function deleteImageRequest(imageId, hostId) {
            try {
                const response = await fetch(`/api/images/${imageId}?host_id=${hostId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCsrfToken()
                    },
                    body: JSON.stringify({ force: false })
                });
                const data = await response.json();
                if (response.ok) {
                    showToast(data.message || 'Image deleted', 'success');
                    return true;
                }
                showToast(data.error || 'Failed to delete image', 'error');
                return false;
            } catch (error) {
                showToast('Failed to delete image', 'error');
                return false;
            }
        }

        function toggleSelectAllImages(checkbox) {
            const items = document.querySelectorAll('.image-select');
            items.forEach(item => {
                item.checked = checkbox.checked;
            });
            updateSelectedCount();
        }

        function updateSelectedCount() {
            const items = Array.from(document.querySelectorAll('.image-select'));
            const checkedItems = items.filter(item => item.checked);
            const countLabel = document.getElementById('selectedCount');
            countLabel.textContent = `${checkedItems.length} selected`;

            const selectAll = document.getElementById('selectAllImages');
            if (items.length === 0) {
                selectAll.checked = false;
                selectAll.indeterminate = false;
                return;
            }
            selectAll.checked = checkedItems.length === items.length;
            selectAll.indeterminate = checkedItems.length > 0 && checkedItems.length < items.length;
        }

        function clearSelections() {
            const selectAll = document.getElementById('selectAllImages');
            if (selectAll) {
                selectAll.checked = false;
                selectAll.indeterminate = false;
            }
            const countLabel = document.getElementById('selectedCount');
            if (countLabel) {
                countLabel.textContent = '0 selected';
            }
        }

        async function deleteSelectedImages() {
            const items = Array.from(document.querySelectorAll('.image-select')).filter(item => item.checked);
            if (!items.length) {
                showToast('Select at least one image', 'error');
                return;
            }

            if (!confirm(`Delete ${items.length} selected image(s)?`)) {
                return;
            }

            for (const item of items) {
                await deleteImageRequest(item.dataset.imageId, item.dataset.hostId);
            }
            loadImages();
        }
        document.addEventListener('DOMContentLoaded', async () => {
            if (localStorage.getItem('darkMode') === 'enabled') {
                document.body.classList.add('dark-mode');
            }
            await loadHosts();
            await loadImages();
        });
    </script>
</body>
</html>
