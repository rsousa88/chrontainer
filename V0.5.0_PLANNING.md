# Chrontainer v0.5.0 - Evolution to Light Docker Manager

## Vision

Transform Chrontainer from a specialized scheduler into an **all-around, lightweight Docker manager** for home labs - a Portainer alternative without the bloat.

**Target Users:** Home lab enthusiasts, self-hosters, small teams  
**Key Differentiator:** Lightweight, fast, and scheduling-first (keep what makes us unique)

---

## Core Philosophy

- **Lightweight:** <100MB RAM footprint (current ~50-80MB)
- **Fast:** Sub-second page loads, instant actions
- **Scheduling-First:** Keep scheduler as primary feature, add management around it
- **No Bloat:** Only essential features, no enterprise complexity

---

## v0.5.0 Feature Roadmap

### 1. Container Management (Enhanced)

**Current State:** Basic start/stop/restart/pause/update  
**Target State:** Full lifecycle management

**Add:**
- [ ] Create/deploy containers (simple form + docker-compose import)
- [x] Delete containers (with volume cleanup options)
- [x] Rename containers
- [ ] Clone/duplicate containers (copy config)
- [ ] Bulk operations (multi-select: start/stop/delete)
- [ ] Container inspection (full JSON view with search)
- [ ] Resource limits (CPU/memory constraints per container)
- [ ] Environment variable editor (add/edit/delete)
- [ ] Port mapping editor
- [ ] Volume management (attach/detach)
- [ ] Network assignment
- [ ] Restart policy editor

**UI Changes:**
- Expandable container rows (show full details inline)
- Quick-edit mode (toggle between view/edit)
- Container creation wizard (3-step: image → config → advanced)

---

### 2. Image Management

**Current State:** None (images only visible via containers)  
**Target State:** Basic registry and local image management

**Add:**
- [ ] List all local images (size, created date, tags)
- [ ] Pull images from registries (Docker Hub, GHCR, custom)
- [ ] Delete unused images (with dangling detection)
- [ ] Image history/layers view
- [ ] Search Docker Hub (inline search bar)
- [ ] Bulk image operations (prune, delete multiple)
- [ ] Private registry authentication (credentials storage)
- [ ] Image size visualization (pie chart of disk usage)

**UI:**
- New "Images" page (like containers dashboard)
- Filter by: repository, tag, size, age
- One-click deploy from image

---

### 3. Volume Management

**Current State:** None  
**Target State:** Full volume lifecycle

**Add:**
- [ ] List all volumes (name, driver, mountpoint, size)
- [ ] Create volumes (name, driver, labels)
- [ ] Delete volumes (with "in use" warnings)
- [ ] Browse volume contents (file explorer UI)
- [ ] Backup volumes (tar.gz download)
- [ ] Restore volumes (upload tar.gz)
- [ ] Prune unused volumes
- [ ] Volume usage statistics

**UI:**
- New "Volumes" page
- File browser modal (read-only for safety)
- Backup/restore buttons

---

### 4. Network Management

**Current State:** None  
**Target State:** Basic network operations

**Add:**
- [ ] List networks (name, driver, subnet, containers)
- [ ] Create networks (bridge, macvlan, custom)
- [ ] Delete networks (with "in use" warnings)
- [ ] Connect/disconnect containers
- [ ] Network inspection (IP assignments, gateway)
- [ ] Prune unused networks

**UI:**
- New "Networks" page
- Network diagram (visual topology - defer to v0.6+)

---

### 5. Stack Management (Docker Compose)

**Current State:** Basic stack detection (label-based grouping)  
**Target State:** Full Compose support

**Add:**
- [ ] Deploy stack from docker-compose.yml (upload or paste)
- [ ] List stacks with service counts
- [ ] Start/stop/restart entire stack
- [ ] Update stack (redeploy with new compose)
- [ ] Delete stack (remove all services + networks + volumes)
- [ ] View stack compose file (edit and redeploy)
- [ ] Stack logs (aggregate from all services)
- [ ] Stack resource usage (combined CPU/RAM)

**UI:**
- New "Stacks" page
- Compose editor with syntax highlighting (use CodeMirror or Monaco)
- One-click stack actions

---

### 6. Enhanced Monitoring

**Current State:** Basic CPU/RAM stats, host metrics  
**Target State:** Comprehensive monitoring and alerting

**Add:**
- [ ] Container health checks (configure + monitor)
- [ ] Historical metrics (7-day charts with Chart.js)
- [ ] Alerts (threshold-based: CPU >80%, memory >90%, etc.)
- [ ] Container events stream (live feed: start, stop, die, etc.)
- [ ] Log aggregation (search across containers)
- [ ] Disk I/O stats
- [ ] Network I/O stats
- [ ] Process list per container (top-like view)

**UI:**
- Enhanced metrics page with time-series graphs
- Alert configuration in settings
- Events page (real-time log with filters)

---

### 7. Registry Management

**Current State:** None  
**Target State:** Multi-registry support

**Add:**
- [ ] Add custom registries (GHCR, Quay, Harbor, private)
- [ ] Manage credentials per registry
- [ ] Browse registry catalogs
- [ ] Search across multiple registries
- [ ] Auto-update from specific registries (schedule pulls)

**UI:**
- Settings → Registries tab
- Registry credentials encrypted in DB

---

### 8. Security Enhancements

**Add:**
- [ ] User management UI (create/delete/edit users)
- [ ] Granular permissions (per-container ACLs)
- [ ] Audit log viewer (who did what, when)
- [ ] 2FA support (TOTP)
- [ ] API key scopes (restrict to specific containers/hosts)
- [ ] Webhook IP whitelist
- [ ] Session timeout configuration

---

### 9. Backup & Restore

**Add:**
- [ ] Full system backup (DB + config export)
- [ ] Container config export (JSON)
- [ ] Scheduled backups
- [ ] One-click restore
- [ ] Export/import schedules

---

## Technical Changes

### Database Schema

**New Tables:**
```sql
-- Volume management
volumes (id, name, driver, mountpoint, size, created_at)

-- Networks
networks (id, name, driver, subnet, gateway, created_at)

-- Stacks
stacks (id, name, compose_content, created_at, updated_at)
stack_services (id, stack_id, container_id)

-- Image metadata
images (id, image_id, repository, tag, size, created_at)

-- Registries
registries (id, name, url, username, password_encrypted, created_at)

-- Alerts
alerts (id, container_id, metric, threshold, action, enabled)

-- User management
user_permissions (user_id, resource_type, resource_id, permission)

-- Audit log
audit_log (id, user_id, action, resource, timestamp, details)
```

### API Endpoints (New)

```
# Images
GET    /api/images
POST   /api/images/pull
DELETE /api/images/<id>
POST   /api/images/prune

# Volumes
GET    /api/volumes
POST   /api/volumes
DELETE /api/volumes/<id>
GET    /api/volumes/<id>/browse
POST   /api/volumes/<id>/backup
POST   /api/volumes/<id>/restore

# Networks
GET    /api/networks
POST   /api/networks
DELETE /api/networks/<id>

# Stacks
GET    /api/stacks
POST   /api/stacks
PUT    /api/stacks/<id>
DELETE /api/stacks/<id>

# Container creation
POST   /api/containers/create
POST   /api/containers/<id>/clone

# Monitoring
GET    /api/containers/<id>/events
GET    /api/containers/<id>/processes
GET    /api/metrics/historical?range=7d

# Alerts
GET    /api/alerts
POST   /api/alerts
PUT    /api/alerts/<id>
```

### Frontend Architecture

**Recommendation:** Keep single-page vanilla JS, but modularize

```
templates/
  ├── index.html          # Container dashboard
  ├── images.html         # New: Image management
  ├── volumes.html        # New: Volume management
  ├── networks.html       # New: Network management
  ├── stacks.html         # New: Stack management
  ├── monitoring.html     # Enhanced: Metrics + alerts
  ├── events.html         # New: Event stream
  └── components/
      ├── container-wizard.js
      ├── compose-editor.js
      └── metric-charts.js
```

**Libraries to Consider:**
- Chart.js (metrics visualization)
- CodeMirror or Monaco (YAML/JSON editing)
- Sortable.js (drag-drop for ordering)

---

## Migration Path

### For Existing Users (0.4.x → 0.5.0)

1. **Database Migration:**
   - Alembic migration to add new tables
   - Preserve all existing schedules, hosts, tags, webhooks

2. **UI Navigation:**
   - Add top menu: Containers | Images | Volumes | Networks | Stacks | Monitoring | Settings
   - Keep current containers page as default (familiar UX)

3. **Backwards Compatibility:**
   - All existing API endpoints unchanged
   - New endpoints additive only
   - No breaking changes to docker-compose.yml

---

## Implementation Priority

### Phase 1: Core Management (4-6 weeks)
1. Container creation/deletion/editing
2. Image management (pull/delete/prune)
3. Volume management (list/create/delete)
4. Network management (list/create/delete)

### Phase 2: Advanced Features (3-4 weeks)
5. Stack management (compose deploy/update/delete)
6. Enhanced monitoring (historical metrics, alerts)
7. User management UI

### Phase 3: Polish & Power Features (2-3 weeks)
8. Backup/restore
9. Registry management
10. Audit logging

---

## Key Design Decisions

### 1. Compose Handling
**Decision:** Use Docker SDK for Compose operations (not shell exec)  
**Why:** Better error handling, API consistency  
**Note:** Requires `docker-compose` library or manual service orchestration

### 2. File Browser Security
**Decision:** Read-only volume browsing, no write/delete  
**Why:** Prevent accidental data loss  
**Future:** Add write permissions behind admin-only flag (v0.6+)

### 3. Image Pulls
**Decision:** Async pull with progress streaming via SSE  
**Why:** Large images take time, need user feedback  
**Implementation:** Use Docker SDK streaming + Server-Sent Events

### 4. Resource Usage
**Decision:** Keep memory footprint <100MB even with new features  
**How:** Lazy-load pages, cache aggressively, limit historical data retention

---

## Non-Goals (Out of Scope for v0.5.0)

- ❌ Kubernetes support (Docker only)
- ❌ Swarm mode (single-node focus)
- ❌ Template marketplace (defer to v0.6+)
- ❌ Visual network diagrams (defer to v0.6+)
- ❌ Built-in reverse proxy (use Nginx/Traefik)
- ❌ Container terminal/exec (security risk, use SSH/portainer)
- ❌ Docker registry hosting (use external registry)

---

## Success Metrics

- [ ] Deploy a new container in <5 clicks
- [ ] Manage 100+ containers without performance degradation
- [ ] Memory usage <100MB with all features enabled
- [ ] Page load times <500ms
- [ ] Zero data loss during migrations
- [ ] 100% backwards compatibility with v0.4.x

---

## Developer Notes

### Getting Started
1. Read CLAUDE.md and STRUCTURE.md for current architecture
2. Review ROADMAP.md for v0.4.x feature context
3. Check CODE_REVIEW_2026-01-25.md for recent fixes
4. All changes must pass 54 existing tests + new tests
5. Follow existing patterns (Flask routes, Docker SDK, SQLite)

### Code Style
- Keep functions <50 lines when possible
- Add docstrings to all new functions
- Use type hints for complex functions
- Maintain CSRF protection on all POST/PUT/DELETE
- Rate limit new endpoints (30-60 req/min)

### Testing Requirements
- Write pytest tests for all new endpoints
- Maintain >80% code coverage
- Test multi-host scenarios
- Test error cases (network failures, missing images, etc.)

### Documentation Updates
- Update README.md with new features
- Add API examples to docs/
- Update SECURITY.md if adding auth features
- Keep CLAUDE.md in sync with architecture changes

---

## Product Owner Decisions ✅

**All questions answered - ready for implementation:**

### 1. Container Creation UI
**Decision:** Wizard (step-by-step)
**Details:**
- 3 options: Docker Compose, Form-based, or GitHub repo link
- GitHub integration: Link repo → auto-detect compose files → deploy
- Wizard flow: Select method → Configure → Review → Deploy

### 2. Compose Editor
**Decision:** Both inline editing AND upload
**Implementation:**
- Upload button → file parsed → displays in inline editor
- User can edit after upload
- Syntax highlighting required (CodeMirror/Monaco)

### 3. Volume Browser
**Decision:** Text-based files initially, expand later
**Phase 1:** .txt, .log, .conf, .json, .yaml, .xml, .md, .sh
**Phase 2+:** Images (jpg, png), PDFs (viewer)
**Safety:** Read-only mode, max file size 1MB preview

### 4. Alerts
**Decision:** Use existing notification channels (Discord, ntfy)
**New Requirement:** Add alert configuration page
- Per-event channel selection (container alerts → Discord, metric alerts → ntfy, etc.)
- UI: Settings → Alerts → Event type → Select channels
- Example: "Container CPU >80%" → [✓] Discord [✓] ntfy [ ] Webhook

### 5. Historical Metrics
**Decision:** Configurable retention period
**Options:** 1 day, 7 days (default), 30 days, 90 days
**Implementation:**
- Settings → Monitoring → Retention period dropdown
- Auto-prune old metrics via scheduled job
- Disk space consideration: ~1MB per day per 10 containers

### 6. User Permissions
**Decision:** Role-based (simpler for v0.5.0)
**Roles:**
- Admin: Full access (current default)
- Operator: Manage containers/stacks, no settings/users
- Viewer: Read-only
**Future (v0.6+):** Add resource-based ACLs (per-container permissions)

---

## Estimated Timeline

**Total:** 9-13 weeks (2.5-3 months)

- Phase 1: 4-6 weeks
- Phase 2: 3-4 weeks  
- Phase 3: 2-3 weeks

**Deployment:** Staged rollout (beta branch → main)

---

**Version:** v0.5.0 Planning Document  
**Created:** 2026-01-25  
**Status:** Draft for developer handover  
**Next Steps:** Review with product owner, begin Phase 1 implementation
